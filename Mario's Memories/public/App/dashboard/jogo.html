<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./jogo.css">
    <script src="../js/login.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../js/dash.js">
    </script>

    <title>Quiz Mario</title>
</head>

<body onload="carregarDash()">
    <aside class="barra-jogo">
        <div>OLÁ,<div id="nome_logado" style="color: #FBD000;"></div> </div>
        <nav class="topicos">
            <ul class="indices">
                <button onclick="telaJogo()">Jogo</button>
                <button onclick="telaPontuacao(), vidasSobras()">Pontuação</button>
                <button onclick="telaInstrucao()">Instruções</button>
            </ul>
        </nav>
        <div class="voltar">
            <a href="../Site.html">Sair</a>
        </div>
    </aside>
    <section id="jogo_" class="jogo">
        <div class="versus" id="versusFundo">
            <button class="comecar" onclick="abrir()">COMEÇAR QUIZ</button>
        </div>
        <!-- Conteúdo do Quiz -->
        <div class="quiz">
            <!-- <div id="espaco_tempo" class="tempo-jogo">
               TEMPO <div id="tempo" class="numero"></div>
            </div> -->

            <div id="infoQuestao">
                <span>Fase atual: <span id="spanNumeroDaQuestaoAtual"></span> de 
                    <span id="qtdQuestoes"></span> fases.</span>
            </div>

            <div id="perguntaDaQuestaoAtual">
                <span id="spanQuestaoExibida" class="text-bold"></span>
            </div>

            <div id="infoAlternativas">
                <span><em>Escolha uma opção dentre as abaixo:</em></span>
            </div>

            <div id="opcoes" class="flex-colunar padding-8">

                <div class="fila1-opcoes">
                    <span>
                        <input type="radio" id="primeiraOpcao" name="option" class="radio" value="alternativaA" />
                        <label for="primeiraOpcao" class="option" id="labelOpcaoUm"></label>
                    </span>
                    <span>
                        <input type="radio" id="segundaOpcao" name="option" class="radio" value="alternativaB" />
                        <label for="segundaOpcao" class="option" id="labelOpcaoDois"></label>
                    </span>
                </div>

                <div class="fila2-opcoes">
                    <span>
                        <input type="radio" id="terceiraOpcao" name="option" class="radio" value="alternativaC" />
                        <label for="terceiraOpcao" class="option" id="labelOpcaoTres"></label>
                    </span>
                    <span>
                        <input type="radio" id="quartaOpcao" name="option" class="radio" value="alternativaD" />
                        <label for="quartaOpcao" class="option" id="labelOpcaoQuatro"></label>
                    </span>
                </div>
            </div>

            <div class="fila-botoes">
                <button class="botao-quiz" onclick="submeter()">Submeter</button>
                <button class="botao-quiz" onclick="avancar()">Avançar!</button>
            </div>
            
        </div>     
         <div class="mario-bowser">
                <div class="mario" id="mario_" ><img id="imgMario" src="../elementos/grande.png"></div>
                <div class="bowser" id="bowser_" ><img src="../elementos/faceBowser.png"></div>
            </div>
    </section>
    <section class="pontuacao-geral" id="pontuacao_geral">
        <div class="pontuacao">
            <div class="titulo-topo">
                <h1 class="titulo-pontuacao">Estatísticas: <div id="rank"></div></h1>
                
            </div>
            <div class="resultados">
                <h2>Pontuação Total: <div id="pontuacao_total"></div></h2>
                <h3>Fase 1: <p id="pontuacao_fase1"></p></h3>
                <h3>Fase 2: <p id="pontuacao_fase2"></p></h3>
                <h3>Fase 3: <p id="pontuacao_fase3"></p></h3>
                <div class="dash">DESEMPENHO:
                    <canvas id="barra"></canvas>
                </div>
            </div>
        </div>

        <div class="kpi">
        <h2>Vidas do Mario: <p id="vidas_sobrando"></p></h2>
        <div>
            <img id="vida_Mario" class="vidaMario" src="../elementos/grande.png">
        </div>
        
        <div class="rosca-style">
            <canvas id="rosca"></canvas>
        </div>
        

        </div>
    </section>
    
    <section class="instrucoes">
        
    </section>

    <!--Trilhas sonoras de fundo -->
    <audio id="tocar" src="../audio/musicaBowser.mp3"></audio>
    <audio id="dash" src="../audio/dash.mp3"></audio>
    <audio id="instru" src="../audio/intstrucao.mp3"></audio>
    <audio id="ganhou" src="../audio/conclui.mp3"></audio>
    <audio id="acertou" src="../audio/acertou.mp3"></audio>
    <audio id="gameover" src="../audio/52. Game Over.mp3"></audio>
    <audio id="errou" src="../audio/SMW_Power_Down.oga"></audio>
    <audio id="morreu" src="../audio/dano.mp3"></audio>

</body>
</html>
<!-- <script src="../js/dash.js"></script> -->
<script>

    function vidasSobras() {
    var idUsuariov = sessionStorage.ID_USUARIO;

    fetch(`/pontuacoes/vidasSobras/${idUsuariov}`)
        .then(r => r.json())
        .then(data => {
            console.log("Dados recebidos vidas:", data);
            document.getElementById("vidas_sobrando").innerHTML = data.vidas_restantes;
        })
        .catch(err => console.log(err));
}
 
    var btnSubmeter = document.querySelector('button[onclick="submeter()"]')
    var btnProx = document.querySelector('button[onclick="avancar()"]')

    var divVersus = document.getElementById("versusFundo")
    var divJogo = document.getElementById("jogo_")
    var divPontuacao = document.getElementById("pontuacao_geral")
    var divInstrucoes = document.querySelector(".instrucoes")
    var divIniciar = document.getElementById('versusFundo')
    var divQuiz = document.querySelector('.quiz')
    var divMarioBowser = document.querySelector('.mario-bowser')

    // Trilha sonora
    var tocar = document.getElementById('tocar')
    var dash = document.getElementById('dash')
    var instru = document.getElementById('instru')
    var acerto = document.getElementById('acertou')
    var ganhou = document.getElementById('ganhou')
    var gameover = document.getElementById("gameover")
    var errou = document.getElementById("errou")
    var morreu = document.getElementById("morreu")


    function cadastrarPontuacao() {
        var fase1 = pontuacaoFinal;
        var fase2 = pontuacaoFinal;
        var fase3 = pontuacaoFinal;

        var fk_usuario = sessionStorage.ID_USUARIO

       

        fetch("/partidas/cadastrarPontuacao", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
              
                fase1Server: fase1,
                fase2Server: fase2,
                fase3Server: fase3,
                fk_usuarioServer: fk_usuario
            }),
        }).then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {

                    alert(
                        "Cadastro realizado com sucesso! Redirecionando para tela de Login...");

                                   
                } else {
                    throw `Houve um erro ao tentar realizar o cadastro PONTUACAO! ${fase1} ,  ${fase2} ,  ${fase3} ,  ${fk_usuario}  `;
                   
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
               
            });

        return false;
    }

  
    

    divIniciar.style.display = "none"
    divJogo.style.display = "flex"
    divVersus.style.display = "flex"
    divQuiz.style.display = 'none'
    divInstrucoes.style.display = 'none'
    divMarioBowser.style.display = 'none'

     var vidas = 2

    //Quiz
    let listaDeQuestoes = [
        {
            pergunta: "De quem o Bowser detesta?",
            alternativaA: "Peach",
            alternativaB: "Mario",
            alternativaC: "Goomba",
            alternativaD: "Yoshi",
            alternativaCorreta: "alternativaB"
        },

        {
            pergunta: "Quem o Bowser sempre sequestra?",
            alternativaA: "Daysi",
            alternativaB: "Birdo",
            alternativaC: "Peach",
            alternativaD: "Koopa",
            alternativaCorreta: "alternativaC"
        },

        {
            pergunta: "Quantos castelos Bowser tem?",
            alternativaA: "Dez",
            alternativaB: "1",
            alternativaC: "0",
            alternativaD: "Muitos...",
            alternativaCorreta: "alternativaD"
        }
    ]

    let numeroDaQuestaoAtual = 0
    let pontuacaoFinal = 0
    let quantidadeDeQuestoes = listaDeQuestoes.length

    document.getElementById("qtdQuestoes").innerHTML = quantidadeDeQuestoes

    function abrir(){
        divIniciar.style.display = 'none'
        divJogo.style.display= 'flex'
        divQuiz.style.display = 'flex'
        divMarioBowser.style.display= 'flex'

        limparCoresBackgroundOpcoes();
        desmarcarRadioButtons(); 

        tocar.play();

        preencherHTMLcomQuestaoAtual(0)

        btnSubmeter.disabled = false
        btnProx.disabled = true

        vidas =2
        numeroDaQuestaoAtual = 0;
        pontuacaoFinal = 0;

        document.getElementById("imgMario").src="../elementos/grande.png";

    }

    function preencherHTMLcomQuestaoAtual(index) {
        habilitarAlternativas(true)

        const questaoAtual = listaDeQuestoes[index]
        numeroDaQuestaoAtual = index

        document.getElementById("spanNumeroDaQuestaoAtual").innerHTML = index + 1
        document.getElementById("spanQuestaoExibida").innerHTML = questaoAtual.pergunta
        document.getElementById("labelOpcaoUm").innerHTML = questaoAtual.alternativaA
        document.getElementById("labelOpcaoDois").innerHTML = questaoAtual.alternativaB
        document.getElementById("labelOpcaoTres").innerHTML = questaoAtual.alternativaC
        document.getElementById("labelOpcaoQuatro").innerHTML = questaoAtual.alternativaD
    }

    function submeter() {
        const options = document.getElementsByName("option")

        let selecionou = false
        options.forEach(o => { if (o.checked) selecionou = true })

        if (!selecionou) {
            alert("Escolha uma alternativa.")
            return
        }

        btnSubmeter.disabled = true
        btnProx.disabled = false
        habilitarAlternativas(false)

        checarResposta()
    }

    function checarResposta() {
        const questaoAtual = listaDeQuestoes[numeroDaQuestaoAtual]
        const respostaCorreta = questaoAtual.alternativaCorreta
        
        const options = document.getElementsByName("option")

        let idLabelCorreta = ""

        options.forEach(opt => {
            if (opt.value === respostaCorreta) {
                idLabelCorreta = opt.labels[0].id
            }
        })
        options.forEach(opt => {
            if (opt.checked && opt.value === respostaCorreta) {
                document.getElementById(idLabelCorreta).classList.add("text-success-with-bg")
                pontuacaoFinal+= 100;
                acerto.play();
            }
            else if (opt.checked && opt.value !== respostaCorreta){
                document.getElementById(opt.labels[0].id).classList.add("text-danger-with-bg")
                document.getElementById(idLabelCorreta).classList.add("text-success-with-bg")
                errou.play();
                vidas--
                if(vidas == 1){
                    document.getElementById("imgMario").src="../elementos/pequeno.png";
                }
                else if(vidas == 0){
                    document.getElementById("imgMario").src="../elementos/gameover.png";
                    setTimeout(function() {
                    alert("BOWSER: HAHAHAHHAA VOCÊ PERDEU MARIO");
                    finalizarJogo();
                    morreu.play();
                     }, 500);
                     return
                }
                
            }
        })
        numeroDaQuestaoAtual++
    }

    function avancar() {
        btnProx.disabled = true
        btnSubmeter.disabled = false

        desmarcarRadioButtons()
        limparCoresBackgroundOpcoes()

        if (numeroDaQuestaoAtual < quantidadeDeQuestoes) {
            preencherHTMLcomQuestaoAtual(numeroDaQuestaoAtual)
        } else {
            setTimeout(function() {
                    alert("VOCÊ GANHOU!!");
                    cadastrarPontuacao()
                    finalizarJogo();
                     }, 500);
            finalizarJogo()
            ganhou.play()

        }
    }

    function habilitarAlternativas(habilitar) {
        primeiraOpcao.disabled = !habilitar
        segundaOpcao.disabled = !habilitar
        terceiraOpcao.disabled = !habilitar
        quartaOpcao.disabled = !habilitar
    }

    function desmarcarRadioButtons() {
        document.getElementsByName("option").forEach(o => o.checked = false)
    }

    function limparCoresBackgroundOpcoes() {
        document.getElementsByName("option").forEach(opt => {
            let id = opt.labels[0].id
            document.getElementById(id).classList.remove("text-danger-with-bg")
            document.getElementById(id).classList.remove("text-success-with-bg")
        })
    }

    function finalizarJogo() {
        tocar.pause();

        divJogo.style.display = "none"
        divQuiz.style.display = "none"
        divInstrucoes.style.display = "none"
        divPontuacao.style.display = "flex"

        atualizarMario();
    }

    function atualizarMario(){
        console.log("Atualizando Mario na Dash. Vidas restantes:", vidas);
        var EstadoMario = document.getElementById("vida_Mario")

        if( vidas == 2){
            EstadoMario.src = "../elementos/grande.png";
        }        
        else if (vidas == 1){
            EstadoMario.src = "../elementos/pequeno.png"
        }
        else{
            EstadoMario.src = "../elementos/gameover.png"
        }
    }

    /* Telas */
    function telaJogo(){

        divJogo.style.display = 'flex'
        divVersus.style.display = "flex"
        divPontuacao.style.display = 'none'
        divInstrucoes.style.display = 'none'
        divQuiz.style.display = "none"
        divMarioBowser.style.display = 'none'

        acerto.play()
        instru.pause();
        tocar.pause();
        dash.pause();
    
    }
    function telaPontuacao() {
        divJogo.style.display = 'none'
        divPontuacao.style.display = 'flex'
        divInstrucoes.style.display = 'none'
        
        instru.pause();
        tocar.pause();
        dash.play();

        atualizarMario();
    }
    function telaInstrucao() {
        divJogo.style.display = 'none'
        divPontuacao.style.display = 'none'
        divInstrucoes.style.display = 'flex'

        dash.pause();
        instru.play();
        tocar.pause();
    }
</script>